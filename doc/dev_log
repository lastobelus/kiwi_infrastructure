# forked https://github.com/infochimps-labs/ironfan-homebase
git clone git@github.com:lastobelus/kiwi-ironfan-homebase.git
cd kiwi-ironfan-homebase
bundle install
git submodule update --init
git submodule foreach git checkout master

cp -a example-credentials credentials

cp -a example-credentials credentials
cd credentials/
git init
git add .
gicm "new credentials universe for Kiwi"
git remote add origin git@eable.sourcerepo.com:eable/kiwi-credentials.git
git push -u origin master
mv credentials local-credentials
ln -s local-credentials credentials
knife cluster launch sandbox-simple --bootstrap
cd knife/credentials
cp /Users/lasto/Desktop/_regenerate_key kiwi_test-validator.pem
cp /Users/lasto/Desktop/kiwi_test.pem ./
knife cluster launch sandbox-simple --bootstrap
# first launch didn't work because hadn't pushed up cookbooks and roles to chef server
knife cookbook upload --all
rake roles
# now because of idempotence, can run knife cluster bootstrap
knife cluster bootstrap sandbox



############################################################################
# helloworld cluster
############################################################################
# removed the symlinks to vendor/opscode/cookbooks so I can install them and use chef git merging from now on
cd cookbooks/
rm apache2
#... many more ...
knife cookbook site install apache2
knife cookbook site install application_php
knife cookbook site install haproxy
knife cluster show sandbox
knife cluster kill sandbox

############################################################################
# deploy key for helloworld
############################################################################
cd ~/.ssh
ssh-keygen -f'helloworld_github_deploy_key' -N ''
cat helloworld_github_deploy_key.pub | pbcopy
tr "\n" "#" < helloworld_github_deploy_key | sed 's/#/\\n/g' | pbcopy
# add to data_bags/apps/helloworld.json
knife data bag from file apps data_bags/apps/helloworld.json


# made databags a symlink into knife/credentials/databags
# and use the credentials repo to hold databags

knife data bag create apps
mkdir data_bags/apps
mate data_bags/apps/helloworld.json

#### When developing ####
export CHEF_USER=kiwi_test





############################################################################
# setting up cuken
############################################################################
# ironfan-ci was proving complicated and confusing to setup, so I decided to first try to do some acceptance tests of my helloworld cluster using cuken directly
#

############################################################################
# setting up minitest
############################################################################
git co -b minitest
knife cookbook site install minitest-handler --branch minitest
knife cookbook upload minitest-handler
